# database

## 目的
- DB/MySQL
- ActiveRecord基本
- ActiveRecord100本ノック

## 資料
- [スプレッドシート](https://docs.google.com/spreadsheets/d/18PJxt2J6ilDqTORwpL9DJw96858me_MurEYDa3ofDio/edit#gid=0)

## WIP
- ファイル名を内容に合わせたものに修正すべき


#§DB基礎
##1. DB概要
###1-1. DBとは
DB(データベース)とは一定のルールで管理されたデータの集合体のことを指し、一般的に複数の表でデータ同士の関係を定義し、管理するRDB(リレーショナルデータベース)を指します。
RDBを管理するソフトウェアをリレーショナルデータベースマネージメントシステム(RDBMS)と言います。

###1-2. DBの種類
現在以下のRDBMSが市場の大部分のシェアを占めています。
・Oracle
・MySQL
・Microsoft SQL Server
・DB2
・PostgreSQL

同じRDMBSでも信頼性、拡張性、高可用性などシステムに求められる要件や予算に応じて商用やオープンソースのRDBMSが選定され、使用されています。

商用RDBMSの代表的なものがOracleやDB2となり、大規模で堅牢性の高いシステムで用いられることが多く、大企業を中心に幅広く利用されています。

オープンソースのRDBMSの代表的なものはMySQLやPostgreSQLとなり、大企業や中小企業問わず幅広く利用されており、小規模なシステムから大規模なシステムまで用途も様々です。

###1-3. DB使用例
実際にシステム上ではどのように使用されているかの具体例(フォームで登録されたデータを格納、それを参照してなんとかみたいなイメージが分かるようなものを図で説明)

##2. MySQL操作
ここではMySQLの使用方法について説明します。
以降の説明は全てMySQLログイン後のコマンドライン上の操作となります。

- MySQLログイン方法
① コマンドラインで以下を入力
mysql -u(ユーザ名) -p
②パスワードを入力
「Enter password:」と表示されるので、パスワードを入力する。
ログインが成功すると、Welcomeメッセージが表示され、プロンプト「mysql>」が表示されます。

- MySQLログアウト方法
コマンドライン上で「exit」もしくは、「\q」と入力し、Enterキー押下。

###2-1. DB作成、選択(useコマンド)
RDBMSはデータベースという入れ物の中にテーブル(表)があり、そのテーブルの中にデータが格納されるという構成となります。
MySQLをインストールすると、デフォルトでmysql,information_schemaなどの管理用DBが作成されていますが、
アプリケーションで使用する為のDBをまずは作成する必要があります。

- 新規データベース作成コマンド
create database データベース名;

- 作成したデータベースへのアクセス
use データベース名;

###2-2. DB、テーブルの一覧表示コマンド(show databases, show tables)
既存のものや新規作成したものなど、アクセスしたMySQLにどのようなDBがあり、どのようなテーブルが格納されているかについて以下のコマンドで確認が出来ます。

- データベース一覧表示コマンド
show databases;

- テーブル一覧表示コマンド(※対象のDBを事前にuseで指定する必要があります)
show tables;

###2-3. テーブル定義の確認コマンド(desc)
テーブルに格納されているデータを確認する方法は後述しますが、どのような定義のテーブルにデータが入っているのかを以下のコマンドで確認できます。

- テーブル定義確認コマンド
desc テーブル名;

###2-4. アカウント作成・削除、権限付与・削除
各DBにアクセスするアカウントを作成し、利用可能な操作(権限)を設定することが出来ます。
作成したアカウントは削除、権限のみの変更も可能です。
実際に公開するシステムの場合は、セキュリティ、データ保護の観点から、用途に応じた必要最低限のアカウント作成、権限に抑えることに留意して下さい。

- アカウント作成コマンド
create user ユーザ名 identified by 'パスワード';

- 権限付与コマンド
grant 権限名 on 対象DB名.対象テーブル名 to 対象ユーザ名;

- 権限削除コマンド
revoke 権限名 on 対象DB名.対象テーブル名 from 対象ユーザ名;

- 現在の権限の確認コマンド
show grants for 対象ユーザ名;

- アカウント削除コマンド
drop user 対象ユーザ名;

###2-5. アカウントの権限の種類について
付与可能な権限はMySQL公式ページを参照。
https://dev.mysql.com/doc/refman/5.6/ja/privileges-provided.html

###2-6. SQLの実行(SQL実行、出力結果整形等(\G))
テーブルへのデータ登録、登録されているデータの確認や更新、削除にはSQLと呼ばれる言語を使用します(詳細は第3章で説明)。

例えば、コマンドラインから以下のようなSQLを実行するとデータの参照ができます。

- (例)
select * from test;
※SQLは大文字、小文字どちらでも問題ありませんが、テーブル名はデフォルト設定だと大文字、小文字の区別がされるので注意が必要です。
※テーブル名、カラム名はtabキーで入力補完されます。

###2-7. その他コマンドプロンプト小技
#### \G
- SQLでデータ参照の際、末尾に「;」の代わりに「\G」を指定すると、抽出データを縦に表示させ見やすく表示することが出来ます(テーブルのカラム数が多い場合に重宝します)。

#### \c
- 入力途中のSQLをキャンセルしたい場合、「\c」と入力すると中途半端な状態で実行やSQLを削除しなくても改行されて、途中でキャンセルされます。

#### \s
- DBへの接続情報が表示されます。

#### \q
- MySQLからログアウト



##3.テーブル定義、データ操作基礎
この章では、実際にデータを格納するテーブルの作成方法や更新、削除方法及び、テーブルを使用したデータ操作(登録、参照、更新、削除)について説明します。

###DDL
DDLとはData Definition Languageの略で、データベースのテーブルの作成や変更、削除を行う言語です。

#### テーブル作成
以下のDDLでデータを格納するテーブルが作成できます。
create table テーブル名 (カラム名1 データ型 制約 制約・・, カラム名2 データ型 制約 制約・・・,);
※データ型や制約については次項以降で説明します。

#### データ型(varchar, int, date, datetime, timestamp, text, blob, enum)
テーブルに格納するデータの種類をデータ型を指定することで制限することが出来ます。
データ型の種類は公式ページを参照(https://dev.mysql.com/doc/refman/5.6/ja/data-types.html)

##### 各データ型の使い分け等について
- 数値型(tinyint,smallint,mediumint,int,bigint)
数値データのみを格納できるデータ型。格納するデータの最大サイズに応じて、tinyintやsmallint,intなどを使い分けて使用。
(使用例)
tinyint型 性別などのフラグや分類などのフラグを格納など
int型 部署ごとの売上やIDの格納など

- 日付型(date,datetime,timestamp)
日付形式のデータのみを格納できるデータ型。
日付のみか時間まで保持するかにより、使い分けて使用。
(使用例)
date型 生年月日、有効期日データの格納など
datetime型 アクセス日時や登録日時の格納など(MySQL 5.6.5以降のバージョンではtimestamp型と同様に自動で更新日時を設定することが可能となりました)
timestamp型 アクセス日時や登録日時の格納など

- 文字列型1(varchar)
数百文字程度(半角、全角問わず)までの任意のテキスト文字列を格納するのに適しているデータ型。定義する際に最大使用サイズを指定して定義します。
(使用例)氏名、住所、メールアドレスの格納など

- 文字列型2(tinytext,text,mediumtext,longtext)
varchar型よりサイズの大きいテキスト文字列を格納する場合に適しているデータ型。
それぞれの型で格納できる最大サイズは決まっている為、用途により使い分けを行います。
(使用例)
紹介文や説明文等、数百〜数千文字程度の文字数が格納される可能性があるデータの格納など

- バイナリ型(tinyblob,blob,mediumblob,longblob)
バイナリ形式のデータ型を格納する際に使用するデータ型。
それぞれの型で格納できる最大サイズは決まっている為、用途により使い分けを行います。
(使用例)
画像ファイルの格納など


#### 制約
- Not NUll制約
必須項目など、必ずデータを格納する項目に指定する。

- キー制約(Primary Key, Unique Key, Foreign Key)
Primary Key
主キーと呼ばれるテーブル内で一意の値を特定する為に使用するカラムに指定。
複数項目で一つの主キーとすることも可能。
このキーを設定した項目は同時にNOT NULL制約が付与され、後述のインデックスも設定される。
(使用例)
・ユーザ情報テーブルのユーザIDに指定
・グループメンバーテーブルのグループID、メンバーIDに指定(複数指定時)

Unique Key
主キーとしては使用しないが、一意性のみを保持したい場合に指定。
(使用例)
ユーザ情報テーブルのメールアドレスの指定

- デフォルト値
テーブルへのデータ登録時に何も指定されていなかった場合に設定する値を指定。
(使用例)
・商品マスタ(商品情報テーブル)の金額項目未指定時に0をセット
・登録日時項目未指定時に現在時刻をセット

- Auto Increment
自動で数値項目の値を増やしたい際に指定。
(使用例)
・ユーザ情報テーブルのユーザID
・商品マスタの商品ID

- テーブル定義変更
カラムの追加
alter table テーブル名 add(カラム名1 データ型 制約 制約・・, カラム名2 データ型 制約 制約・・・,);

カラムの変更
alter table テーブル名 modify(カラム名1 データ型 制約 制約・・, カラム名2 データ型 制約 制約・・・,);

カラムの削除
alter table テーブル名 drop(カラム名1, カラム名2, カラム名3);


- テーブル削除
drop table テーブル名;

- Index
インデックスとは膨大なデータから該当データを高速に検索する為の仕組みで、
数万件を超えるような多くのデータを管理するテーブルには欠かせない設定となっています。

(インデックス作成方法)
create index インデックス名 ON テーブル名 (カラム名1,カラム名2,・・・);

作成したインデックスを削除する場合は以下となります。
drop index インデックス名 on テーブル名;

###DML
DMLとはData Manipulation Languageの略で、DBののテーブルにデータを登録したり、読み込み、変更、削除を行う言語です。

- INSERT
テーブルにデータを登録します。
insert into テーブル名 (カラム名1, カラム名2, カラム名3,・・・・) values (カラム1に格納する値, カラム2に格納する値, カラム3に格納する値,...);

- SELECT
テーブルに格納されているデータを抽出します。
select カラム名1, カラム名2, カラム名3, ・・・ from テーブル名 WHERE (対象データ指定条件);

- UPDATE
テーブルに格納されているデータを更新します。
update テーブル名 set カラム名1=更新する値, カラム名2=更新する値 WHERE (対象データ指定条件);

- DELETE
テーブルに格納されているデータを削除します。
delete from テーブル名 where (対象データ指定条件);

- 条件指定(WHERE句,AND, OR, NOT NULL, LIKE, BETWEEN)
対象データの条件を指定する。
select * from テーブル名 where カラム名1 = 指定条件;

AND - 条件1 且つ、条件2のような複数の条件を指定時に使用します。
(実行方法)カラム名1が指定条件1、且つ、カラム名2が指定条件2のデータを抽出
select * from テーブル名 where カラム名1 = 指定条件1 and カラム名2 = 指定条件2;

OR - 条件1 もしくは、条件2のような複数条件を指定時に使用します。
(実行方法)カラム名1が指定条件1、もしくは、カラム名2が指定条件2のデータを抽出
select * from テーブル名 where カラム名1 = 指定条件1 or カラム名2 = 指定条件2;

LIKE - 値を前方一致、後方一致もしくは、前後方一致で絞り込む時に使用します。
(実行方法)カラム名1が「aaa」で始まるデータを抽出
select * from テーブル名 where カラム名1 like 'aaa%';

IN - 複数の値をOR条件として指定してデータを抽出する際に使用します。
(実行方法)カラム名1が「aaa」もしくは、「bbb」のデータを抽出
select * from テーブル名 where カラム名1 in ('aaa', 'bbb');

- グループ化(GROUP BY, HAVING句)
抽出データをグループでまとめる場合に指定。
(実行方法)カラム名2ごとの合計値の抽出
select sum(カラム名1), カラム名2 from テーブル名 group by カラム名2;

- 順序指定(ORDER BY句)
selectで抽出するデータの出力順序を指定します。
並べ替えをしたいカラムは複数指定可能で、指定した順番に第1ソート、第2ソートとなります。
順序は昇順(asc)、降順(desc)の2つの指定が可能となります。

order by句を指定しない場合、一定の順序(selectで抽出項目として指定した一番左のカラムの昇順)で並び替えが行われますが、仕様上は明記されておらず、
順序は保証されていません。必ず決まった順序で結果を取得する必要がある場合は、order by句を使用して下さい。
-asc 昇順に並び替える。昇順、降順未指定時はこちらの指定がデフォルトとなります。昇順という意味の英語ascendingの略。
-desc 降順に並び替える。降順という意味の英語descendingの略。

(実行方法)
select * from テーブル名 order by 順序を並べ替えたいカラム名1 desc, 順序を並べ替えたいカラム名2 asc,・・・;


- 取得件数、取得位置指定(LIMIT, OFFSET句)
selectの抽出結果の件数や取得開始位置、終了位置を指定することが出来ます。

(実行方法)抽出件数のみ指定時
select * from テーブル名 limit (取得したい件数);

(実行方法)抽出範囲指定時
select * from テーブル名 limit (抽出開始位置(0から)) (抽出開始位置から取得したい件数);

- テーブル結合(JOIN)
複数のテーブルを結合して結果を取得することが出来ます。
テーブルの結合方法はいくつかありますが、代表的なものをここでは紹介します。

- INNER JOIN
2つのテーブルの共通のカラムをキーにして結合を行います。
両方のテーブルに同じ値があるものだけが結合されます。

(実行方法)
select * from テーブル名1 inner join テーブル名2 on (結合条件);

- LEFT JOIN
2つのテーブルの共通のカラムをキーにして結合を行います。
両方のテーブルに一致する値がなくても、左側に指定されているテーブル(以下のSQLだとテーブル名1)のデータは全て抽出され、
テーブル2に一致するデータがあるレコードのみ、テーブル1と結合されて出力されます。

(実行方法)
select * from テーブル名1 left join テーブル名2 on (結合条件);

- 関数(SUM, AVG, MAX, MIN, NOW)
MySQLには便利な関数が色々と用意されています。
ここでは代表的な関数とその使用方法についてご説明します。
SQLで効率よくデータを抽出することで、取得したデータの加工等の手間が省けることも多々ありますので、
最低限基本的な関数だけでもおさえておくと効率よくデータを扱えます。

- SUM関数
合計値の出力

(実行方法)
select sum(集計したいカラム名) from テーブル名;

- AVG関数
平均値の出力

(実行方法)
select avg(平均値を取得したいカラム名) from テーブル名;

- MAX, MIN関数
最大値(MAX)、最小値の出力(MIN)

(実行方法) 最大値の取得
select max(最大値を取得したいカラム名) from テーブル名;

- NOW関数
現在時刻の取得。

(実行方法)
select now();

この他にも色々な関数が用意されていますので、データの抽出で困ることがあれば、
以下の公式ページの関数一覧を参照し、要件を満たす関数が用意されているかご確認頂くのがよいかと思います。
https://dev.mysql.com/doc/refman/5.6/ja/func-op-summary-ref.html

- その他(AS, DISTINCT)
AS - カラムに別名を付けて、データを取得することが出来ます。

(実行方法)
select カラム名 as 別名 from テーブル名;

DISTINCT - 重複データを除外することが出来ます。

(実行方法)
select distinct カラム名1, カラム名2 from テーブル名;
もし、カラム名1とカラム名2で同じ値が複数ある場合、重複データは出力されません。


---
#§DB応用
##1. テーブルの種類について
MySQLにはInnoDBとMyISAMという主に2種類のテーブルタイプがあります。
それぞれ役割は決まっており、特徴は以下となります。

### InnoDB
・トランザクション処理(後述)が可能
・行単位でロックする(状況によってテーブルロックとなる)

### MyISAM
・トランザクション処理ができない
・テーブル単位でロックする

行ロックとテーブルロックの違いですが、
updateやdelete等のDMLはデータの整合性を保つ為、実行時にテーブル内の対象データが他のリクエストで更新されないようにロック(他のリクエストをブロックする)を掛ける仕組みとなっていますが、そのロック対象がテーブル全体なのか、影響のある行のみロックするかの違いとなります。
ロックされたレコードに対してはupdateやdeleteで更新や削除が出来ませんので、他のリクエストがデータの更新を実施する場合はロックが解除されるまで待たなければなりません。

また、ロック方法についても種類があり、排他ロックと共有ロックというものがあるのですが、
大きな違いとしては、排他ロックは他のdelete,updateのリクエストをブロックし、selectの読み込みもブロックするが
共有ロックはdelete,updateのリクエストは同じようにブロックしますが、selectの読み込みは許容するものとなります。



##2. データ入出力
MySQLに格納されているデータをテーブル定義ごとファイルに出力、もしくは取り込みが可能です。
主にデータのバックアップやDBの移行等の用途で使用します。
※MySQLのコマンドラインからの実行ではなく、ターミナルのコマンドラインからの実行となります。

### テーブルデータの入出力
- 出力
mysqldump -uユーザ名 -p -hホスト名 データベース名 テーブル名1 テーブル名2 ・・・ > 出力先ファイル名

- 入力
mysql -uユーザ名 -p -hホスト名 データベース名 < 出力先ファイル名


### DBの入出力
- 出力
mysqldumpというコマンドを使用します。

(出力方法)
mysqldump -uユーザ名 -p -hホスト名 -B データベース名1 データベース名2 ・・・ > 出力先ファイル名

(入力方法)
mysql -uユーザ名 -p -hホスト名 < 入力ファイル名

##3. 高度なデータ操作
### トランザクション制御(commit, rollback)
複数テーブルへのデータインサートや複数テーブルの同時更新など、
一つの操作で複数のINSERTやUPDATEもしくは、DELETEを実行する必要が
ある場合に全ての更新処理が完了して始めてDBのデータを確定し、一つでも
エラーがあった場合は全ての更新処理を戻す(ロールバックする)ことが可能です。

(例)
・ECサイトで商品を購入した際に購入した商品情報を購入情報登録、商品在庫の更新
・ユーザ登録フォームから登録されたデータのユーザマスタへの登録、関連情報テーブルへの登録など

(使用方法)
begin; ← トランザクションを開始
insert、updateまたは、deleteなどのSQLを実行(この時点ではまだ実際にテーブルは更新されていない)
commit; ← 更新内容を確定(更新をせずに終了する場合は、「rollback」を実行)

### 副問合せ(サブクエリ)
副問合せ(サブクエリ)とはSQLのSELECT文を入れ子にして実行するSQLで、入れ子(副問合せ)の結果を利用して、データを抽出することが出来ます。
入れ子の内側のSQLを副問合せといい、入れ子の外側のSQLを主問合せといいます。

(使用方法)
以下のSQLでテーブル名2の結果を元にテーブル名1からデータを抽出します。
select * from テーブル名1 where カラム名1 = (select カラム名2 from テーブル名2 where・・・);


---
#RubyとDBの連携(Active Record)
##1. Active Recordとは
- Active Record、ORMについて
- 使用ルールについて(命名規則など)

##2. Active Recordによるデータ操作
- データ操作方法について(CRUD)
- バリデーションについて
- コールバックについて
- マイグレーションについて
